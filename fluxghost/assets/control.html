<!DOCTYPE html>
<html>
<head>
  <title>FLUXStudio - Control</title>
  <script src="/res/jquery-2.1.4.min.js"></script>
  <script src="/res/bootstrap/js/bootstrap.min.js"></script>
  <link href="/res/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
  <meta charset="UTF-8">
  <script src="shared.js"></script>
  <style>
  .fileinput-button {
    position: relative;
    overflow: hidden;
  }
  .fileinput-button input {
    position: absolute;
    top: 0;
    right: 0;
    margin: 0;
    opacity: 0;
    -ms-filter: 'alpha(opacity=0)';
    font-size: 200px;
    direction: ltr;
    cursor: pointer;
  }

  /* Fixes for IE < 8 */
  @media screen\9 {
    .fileinput-button input {
      filter: alpha(opacity=0);
      font-size: 100%;
      height: 100%;
    }
  }
  </style>
  <script>
  function beginControl(serial, name) {
    stopDiscover()
    $(".device_select_ui").hide();
    $(".device_control_ui").show();

    $("#device_label").
      text(name + " (" + serial + ")").
      attr("data-serial", serial);
    connectControl()
  }

  function connectControl() {
    if(window.control_ws) {
      appendLog("Clean old control session", "red");
      window.control_ws.close();
      window.control_ws = undefined;
    }
    var serial = $("#device_label").attr("data-serial");
    appendLog("Connect to " + serial);
    var ws = new WebSocket("ws://" + window.location.host + "/ws/control/" + serial);
    window.control_ws = ws;

    ws.onclose = function(v) {
      if(self.control_ws === ws) {
        self.control_ws = undefined;
      }
      ws_close_handler("Control")(v);
    };

    ws.onmessage = function(m) {
      if(window.control_ws !== ws) { return; }

      try {
        var payload = JSON.parse(m.data);
        if(payload.status === "connecting") {
          appendLog("Connecting... (" + payload.stage + ")", "#444");
        } else if(payload.status === "connected") {
          appendLog("‚ûú Ready")
          appendHtmlLog('<div>' + 
            '<img src="ready.png?" height="60px" />' +
            '<img src="ready.png?" height="60px" />' +
            '<img src="ready.png?" height="60px" />' + '</div>');
          ws.onmessage = cb_standard;
          send_ping();
          send_cmd("position");
        } else {
          appendLog("‚úó Error: "+ m.data + " üò≠", "red");
        }

      } catch(err) {
        appendLog("‚úó Exception: "+ err.message + " üò≠", "red");
      }
    };
  }

  function send_ping() {
    if(window.control_ws) window.control_ws.send("ping");
  }

  function cb_standard(m) {
    var payload;
    try {
      payload = JSON.parse(m.data);
    } catch (e) {}

    if(payload != undefined && payload.status === "ok" &&
       payload.path != undefined && payload.directories != undefined &&
       payload.files != undefined) {
      // List file
      appendLog("List " + payload.path + ":");

      var path = payload.path;
      if(path != "" && path[path.length - 1] != "/") {
        path = path + "/";
      }

      for(var i=0;i<payload.directories.length;i++) {
        var dirname = payload.directories[i];
        var $row = $("<div></div>");
        $row.append($("<span>Dir&nbsp;</span>"));
        $row.append(
          $("<a></a>").
            css("cursor", "pointer").
            attr("data-cmd", "ls " + path + dirname).
            text("[" + path + dirname + "]"));
        appendHtmlLog($row);
      }

      for(var i=0;i<payload.files.length;i++) {
        var filename = payload.files[i];
        var $row = $("<div></div>");
        $row.append($("<span>File&nbsp;</span>"));
        $row.append(
          $("<a></a>").
            css("cursor", "pointer").
            attr("data-cmd", "select " + path + filename).
            text("[" + path + filename + "]"));
        appendHtmlLog($row);
      }
    } else if(payload != undefined && payload.status === "pong") {
      setTimeout(send_ping, 30 * 1000);
    } else {
      var lines = m.data.split("\n");
      for(var i=0;i<lines.length;i++) {
        appendLog(lines[i]);
      }
    }
  }

  function cb_begin_upload(m) {
    try {
      var data = JSON.parse(m.data)

      if(data.status === "continue") {
        appendLog("Uploading file, do not send any commnad before you recive 'ok'");
        var reader = new FileReader();
        reader.onload = file_uploader;
        reader.readAsArrayBuffer(window.upload_file)
        window.upload_file = undefined;
      } else {
        appendLog(data.status, "red");
        window.upload_file = undefined;
      }
    } catch(err) {
      appendLog("‚úó Exception: "+ err.message + " üò≠", "red");
    }
    window.control_ws.onmessage = cb_standard;
  }

  function file_uploader(f) {
    window.control_ws.send(f.target.result);
  }

  function send_cmd(cmd) {
    if(window.control_ws) {
      if(window.control_ws.readyState == 0) {
        appendLog("‚ö†Ô∏è " + cmd, "rgb(208, 142, 40)");
      } else if(window.control_ws.readyState == 1) {
        window.control_ws.send(cmd);
        appendLog("‚û¶ " + cmd);
      } else {
        appendLog("‚ö†Ô∏è " + cmd, "rgb(208, 142, 40)");
        window.control_ws = undefined;
      }
    } else {
      appendLog("‚ö†Ô∏è " + cmd, "rgb(208, 142, 40)");
    }
  }

  $(window).ready(function() {
    $("[data-role=discover]").on("click", function() {
      if(window.discover_ws) {
        stopDiscover()
      } else {
        startDiscover()
      }
    });

    $("[data-role=reset-control]").on("click", function() {
      connectControl();
    });

    $("#controlcmd").on("keypress", function(e) {
      if(e.keyCode == 13) {
        var val = $(this).val();
        send_cmd(val);
        $(this).val("");
        return false;
      }
    });

    $("#log").on("click", "[data-cmd]", function() {
      cl = $(this).attr("data-cmd").split(",")
      for(var i=0;i<cl.length;i++) {
        send_cmd(cl[i]);
      }
    });

    $("[data-cmd]").bind("click", function() {
      cl = $(this).attr("data-cmd").split(",")
      for(var i=0;i<cl.length;i++) {
        send_cmd(cl[i]);
      }
    });

    $(".device_control_ui").hide();

    // Upload File Codes
    $("input[name=file]").on("change", function(evt) {
      var f = evt.target.files[0];

      // Get mimetype
      var mimetype = undefined;
      var filename = f.name.split(".");
      var fileext = filename[filename.length - 1].toLowerCase();
      if(fileext == "gcode") {
        mimetype = "text/gcode";
      } else if (fileext == "fcode") {
        mimetype = "application/fcode";
      } else if (fileext == "bin"){
        mimetype = "binary/fireware";
      } else {
        alert("Unknow file type");
        return
      }

      if(window.control_ws && window.control_ws.onmessage === cb_standard) {
        var cmd = $(this).attr("data-file-cmd") + " " + mimetype + " " + f.size;

        appendLog("Start uploading... (" + cmd + ")")
        window.control_ws.onmessage = cb_begin_upload;
        window.control_ws.send(cmd);

        window.upload_file = f;
        this.value = "";
      } else {
        appendLog("Upload not start", "blue")
      }
    });
    // End Upload File Codes

    // Begin UI
    $(window).bind('hashchange', function(e) {
      var matchs = /^#[0-9A-Z]+;[\w\W]+$/.exec(document.location.hash);
      if(matchs != undefined && matchs.length == 1) {
        var tags = matchs[0].split(";");
        var serial = tags[0].substr(1);
        var name = tags.slice(1).join(";");

        beginControl(serial, name);
      } else {
        $(".device_select_ui").show();
        $(".device_control_ui").hide();
        startDiscover();
      }
    }).trigger("hashchange");;
  });
  </script>
</head>
<body>
  <div class="container-fluid">
    <div class="row" style="padding-top: 1em">
      <div class="col-xs-10">
        <strong>./fluxghost/assets/control.html</strong>
      </div>
      <div class="col-xs-2">
        <a href="index.html" class="btn btn-xs btn-primary">Back to Index</a>
      </div>
    </div>
  </div>
  <hr />
  <div class="container-fluid device_select_ui">
      <div class="list-group" id="devices"></div>
  </div>
  <div class="container-fluid" style="margin-bottom: 5px;">
    <div class="col-xs-8">
      <a class="btn btn-sm btn-success device_select_ui" data-role="discover">Start Discover</a>
      <label id="device_label" class="device_control_ui"></label>
    </div>
    <div class="col-xs-4 text-right">
      <a class="btn btn-sm btn-warning device_control_ui" data-role="reset-control">
        <i class="glyphicon glyphicon-repeat"></i>
        Reset Connection
      </a>
      <a href="#" class="btn btn-sm btn-default device_control_ui" data-role="end-control">
        <i class="glyphicon glyphicon-th-list"></i>
        Back to device lists
      </a>
    </div>
  </div>
  <div class="container-fluid device_control_ui">
    <div class="col-xs-12">
      <div class="form-control" style="height: 400px; overflow-y: scroll; border: 1px gray solid" id="log"></div>
    </div>
  </div>
  <div class="container-fluid device_control_ui">
    <div class="col-xs-12">
      <div style="margin: 5px 0">
        Êá∂Êá∂ DER
        <span data-cmd="position" class="btn btn-xs btn-default">Position</span>
        <span data-cmd="report" class="btn btn-xs btn-default">Report</span>
        <span data-cmd="ls" class="btn btn-xs btn-default">List files</span>
        <span data-cmd="start" class="btn btn-xs btn-primary">Start</span>
        <span data-cmd="abort,quit" class="btn btn-xs btn-danger">Abort+Quit</span>
        <span data-cmd="quit" class="btn btn-xs btn-warning">Quit</span>
        <span data-cmd="raw" class="btn btn-xs btn-info">Raw</span>
        <span data-cmd="G28" class="btn btn-xs btn-primary">G28</span>
        <span data-cmd="G92 E0,G1 F200 E200" class="btn btn-xs btn-default">ÈÄÅÊñô</span>
        <span data-cmd="-HO2000" class="btn btn-xs btn-default">Temp 200 (HO2000)</span>
        <span data-cmd="-HO2100" class="btn btn-xs btn-default">Temp 210 (HO2100)</span>
        <span data-cmd="-RT" class="btn btn-xs btn-default">Temp? (RT)</span>

        <span data-cmd="kick" style="margin-left: 10px;" class="btn btn-xs btn-danger">Kick</span>
      </div>
    </div>
  </div>
  <div class="container-fluid device_control_ui">
    <div class="col-xs-12">
      <div class="input-group input-group">
        <span class="input-group-addon">
          <i class="glyphicon glyphicon-console"></i>
        </span>
        <input id="controlcmd" type="text" class="form-control" />
        <div class="input-group-btn">
          <span class="btn btn-primary fileinput-button">
              <i class="glyphicon glyphicon-upload"></i>
              <span>Upload</span>
              <input type="file" class="fileinput-button" data-file-cmd="upload" name="file" />
          </span>
        </div>
      </div>
    </div>
  </div>
  <div class="container-fluid device_control_ui" style="margin-top: 10px;">
    <div class="col-xs-12">
      <span class="btn btn-xs btn-danger fileinput-button">
          <i class="glyphicon glyphicon-upload"></i>
          <span>** Update Marlin Fireware **</span>
          <input type="file" class="fileinput-button" data-file-cmd="update_fw" name="file" />
      </span>
    </div>
  </div>
</body>
</html>