<!DOCTYPE html>
<html>
<head>
  <title>FLUXStudio - Control</title>
  <script src="res/jquery-2.1.4.min.js"></script>
  <script src="res/bootstrap/js/bootstrap.min.js"></script>
  <script src="res/jsencrypt.js"></script>
  <link href="res/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
  <meta charset="UTF-8">
  <script src="shared.js"></script>
  <link href="res/shared.css" rel="stylesheet" />
  <style>
  .file-node {
    overflow: hidden;
  }

  .file-node:hover {
    z-index: 100;
    overflow: initial;
  }


  .file-node a {
    cursor: pointer;
  }

  .file-node .file-node-container {
    white-space: nowrap;
    padding: 0.2em 0.4em;
    border: 1px white solid;
  }

  .file-node:hover .file-node-container {
    background-color: #FEDFE1;
    border: 1px gray solid;
  }

  .file-node a[data-tag="info"] {
    display: none;
  }

  .file-node:hover a[data-tag="info"] {
    display: initial;
  }

  .file-node:hover a[data-tag="select"] {
    display: inline-block;
  }

  .fileinput-button {
    position: relative;
    overflow: hidden;
  }
  .fileinput-button input {
    position: absolute;
    top: 0;
    right: 0;
    margin: 0;
    opacity: 0;
    -ms-filter: 'alpha(opacity=0)';
    font-size: 200px;
    direction: ltr;
    cursor: pointer;
  }

  /* Fixes for IE < 8 */
  @media screen\9 {
    .fileinput-button input {
      filter: alpha(opacity=0);
      font-size: 100%;
      height: 100%;
    }
  }
  </style>
  <script>
  function beginControl(uuid, name) {
    $("#device_label").
      text(name + " (" + uuid + ")").
      attr("data-uuid", uuid).
      attr("data-name", name);
    connectControl();
  }

  function connectControl() {
    if(window.control_ws) {
      appendLog("Clean old control session", "red");
      window.control_ws.close();
      window.control_ws = undefined;
    }
    var serial = $("#device_label").attr("data-uuid");
    appendLog("Connect to " + serial);
    var ws = new WebSocket("ws://" + window.location.host + "/ws/control/" + serial);
    window.control_ws = ws;

    ws.onopen = function(v) {
      ws.send(getKeyPem());
    }

    ws.onclose = function(v) {
      if(self.control_ws === ws) {
        self.control_ws = undefined;
      }
      ws_close_handler("Control")(v);
    };

    ws.onmessage = function(m) {
      if(window.control_ws !== ws) { return; }

      try {
        var payload = JSON.parse(m.data);
        if(payload.status === "connecting") {
          appendLog("Connecting... (" + payload.stage + ")", "#444");
        } else if(payload.status === "connected") {
          appendLog("‚ûú Ready")
          appendHtmlLog('<div>' +
            '<img src="ready.png?" height="60px" />' +
            '<img src="ready.png?" height="60px" />' +
            '<img src="ready.png?" height="60px" />' + '</div>');

          ws.onmessage = cb_standard;
          send_ping();
        } else {
          if(payload.status === "fatal" && payload.error === "AUTH_ERROR") {
            var $label = $("#device_label");
            appendLog("‚úó Error: Auth failed", "red");
            appendHtmlLog('<a href="touch.html#' + $label.attr("data-uuid") + 
                          ';' + $label.attr("data-name") + '">Go to auth page</a>');
          } else {
            appendLog("‚úó Error: "+ m.data + " üò≠", "red");
          }
        }

      } catch(err) {
        appendLog("‚úó Exception: "+ err.message + " üò≠", "red");
      }
    };
  }

  function send_ping() {
    if(window.control_ws) window.control_ws.send("ping");
  }

  function cb_standard(m) {
    var payload;
    try {
      payload = JSON.parse(m.data);
    } catch (e) {
      appendLog(m.data, "#F05E1C");
      return;
    }

    if(payload.status === "ok") {
      if(payload.task != undefined) {
        $("[data-cmd-group]").hide()
        if(payload.task === "") {
          $("[data-tag=current_task]").text("");
          $("[data-cmd-group=root]").show();
        } else {
          $("[data-tag=current_task]").text(payload.task);
          $("[data-cmd-group=" + payload.task + "]").show();
        }
        appendLog("ok");
        return;
      }
      if(payload.cmd === "ls" && payload.path != undefined) {
        appendLog("List " + payload.path + ":");

        var path = payload.path;
        if(path != "" && path[path.length - 1] != "/") {
          path = path + "/";
        }

        if(payload.directories != undefined) {
          var $row = $('<div class="row"></div>');
          for(var i=0;i<payload.directories.length;i++) {
            var dirname = payload.directories[i];
            var $item = $(' \
              <div class="col-xs-3 col-md-2 col-lg-1 file-node"> \
                <span class="file-node-container"> \
                  <span class="glyphicon glyphicon-folder-close"></span> \
                    <a style="cursor: pointer;" > \
                      <span data-tag="name"></span> \
                    </a> \
                  </span> \
                </span> \
              </div>');
            $("a", $item).attr("data-cmd", "file ls " + path + dirname);
            $("[data-tag=name]", $item).text("[" + path + dirname + "]");
            $row.append($item);
            appendHtmlLog($row);
          }
        }

        if(payload.files) {
          var $row = $('<div class="row"></div>');
          for(var i=0;i<payload.files.length;i++) {
            var filename = payload.files[i];
            var $item = $(' \
              <div class="col-xs-3 col-md-2 col-lg-1 file-node"> \
                <span class="file-node-container"> \
                  <span class="glyphicon glyphicon-picture"></span> \
                  <a data-tag="select" style="cursor: pointer;"> \
                    <span data-tag="name"></span> \
                  </a> \
                  <a data-tag="info" class="btn btn-xs btn-default"> \
                    <span class="glyphicon glyphicon-info-sign"></span> \
                  </a> \
                </span> \
                </span> \
              </div>');
            $("a[data-tag=select]", $item).attr("data-cmd", "play select " + path + filename);
            $("a[data-tag=info]", $item).attr("data-cmd", "file info " + path + filename);
            $("[data-tag=name]", $item).text("[" + filename + "]");
            $row.append($item);
            appendHtmlLog($row);
          }
        }
        return;
      }
      if(payload.cmd === "md5") {
        appendLog("MD5 " + payload.file + " " + payload.md5);
        return;
      }
    } else if(payload.status === "uploading") {
      if(window.upload_updator) {
        window.upload_updator(payload.sent, payload.amount);
        return;
      }
    } else if(payload.status === "update_hbfw") {
      if(payload.stage === "WRITE") {
        if(window.last_update_write_hbfw) {
          var d = new Date();
          if((d - window.last_update_write_hbfw) < 1500) { return; }
        }

        window.last_update_write_hbfw = new Date();
        appendLog("Update head fw: Write " + payload.written);
      } else {
        appendLog("Update head fw: " + payload.stage);
      }
      return;
    }

    if(payload != undefined && payload.status === "pong") {
      setTimeout(send_ping, 30 * 1000);
    } else {
      var lines = m.data.split("\n");
      for(var i=0;i<lines.length;i++) {
        appendLog(lines[i]);
      }
    }
  }

  function cb_begin_upload(m) {
    try {
      var data = JSON.parse(m.data)

      if(data.status === "continue") {
        appendLog("Uploading file...");
        var reader = new FileReader();
        reader.onload = file_uploader;
        reader.readAsArrayBuffer(window.upload_file)
        window.upload_file = undefined;
      } else {
        appendLog(data.status + ": " + data.error, "red");
        window.upload_file = undefined;
      }
    } catch(err) {
      appendLog("‚úó Exception: "+ err.message + " üò≠", "red");
    }
    window.control_ws.onmessage = cb_standard;
  }

  function file_uploader(f) {
    appendLog("File opened");
    var offset = 0;
    while(offset < f.target.result.byteLength) {
      window.control_ws.send(f.target.result.slice(offset, offset + 3984));
      offset += 3984;
    }
    var $prog = $(' \
      <div style="padding: 0 2em;"> \
        <span class="text_prog"></span> \
      </div> \
      <div class="progress" style="height: 0.5em; margin-bottom: 0.05em;"> \
        <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"> \
        </div> \
      </div>');
    appendHtmlLog($prog);
    var amount = f.target.result.byteLength;
    var updator = function(sent, overwrite_amount) {
      if(overwrite_amount) {
        amount = overwrite_amount;
      }
      var p = sent / amount;
      p = Math.round(p * 1000) / 10;
      $(".progress-bar", $prog).css("width", p + "%");
      $(".text_prog", $prog).text(
        (amount - sent) + " byte(s) left");
    }
    window.upload_updator = updator;
    updator(0);
  }

  function send_cmd(cmd) {
    if(window.control_ws) {
      if(window.control_ws.readyState == 0) {
        appendLog("‚ö†Ô∏è " + cmd, "rgb(208, 142, 40)");
      } else if(window.control_ws.readyState == 1) {
        window.control_ws.send(cmd);
        appendLog("‚û¶ " + cmd);
      } else {
        appendLog("‚ö†Ô∏è " + cmd, "rgb(208, 142, 40)");
        window.control_ws = undefined;
      }
    } else {
      appendLog("‚ö†Ô∏è " + cmd, "rgb(208, 142, 40)");
    }
  }

  $(window).ready(function() {
    $("[data-role=reset-control]").on("click", function() {
      connectControl();
    });

    $("#controlcmd").on("keypress", function(e) {
      if(e.keyCode == 13) {
        var val = $(this).val();
        send_cmd(val);
        $(this).val("");
        return false;
      }
    });

    $("#log").on("click", "[data-cmd]", function() {
      cl = $(this).attr("data-cmd").split(",")
      for(var i=0;i<cl.length;i++) {
        send_cmd(cl[i]);
      }
    });

    $("[data-cmd-guide]").bind("click", function() {
      $("#controlcmd")
        .val($(this).attr("data-cmd-guide"))
        .focus();
    });

    $("[data-cmd]").bind("click", function() {
      cl = $(this).attr("data-cmd").split(",")
      for(var i=0;i<cl.length;i++) {
        send_cmd(cl[i]);
      }
    });

    // Upload File Codes
    $("input[name=file]").on("change", function(evt) {
      var f = evt.target.files[0];

      // Get mimetype
      var mimetype = undefined;
      var filename = f.name.split(".");
      var fileext = filename[filename.length - 1].toLowerCase();
      if(fileext == "gcode") {
        mimetype = "text/gcode";
      } else if (fileext == "fc") {
        mimetype = "application/fcode";
      } else if (fileext == "bin"){
        mimetype = "binary/fireware";
      } else if (fileext == "fxfw") {
        mimetype = "binary/flux-firmware";
      } else {
        alert("Unknow file type");
        return
      }

      if(window.control_ws && window.control_ws.onmessage === cb_standard) {
        if($(this).attr("data-file-cmd") == "upload2sd"){
          var target = prompt("Give SD location (like 'myfcode.fc'");
          var cmd = "upload " + " " + mimetype + " " + 
                      f.size + " SD/" + target;
          console.log(cmd);
        }
        else{
          var cmd = $(this).attr("data-file-cmd") + " " + mimetype + " " + f.size;
        }

        appendLog("Start uploading... (" + cmd + ")")
        window.control_ws.onmessage = cb_begin_upload;
        window.control_ws.send(cmd);

        window.upload_file = f;
        this.value = "";
      } else {
        appendLog("Upload not start", "blue")
      }
    });
    // End Upload File Codes

    // Begin UI
    var matchs = /^#[0-9a-fA-F]+;[\w\W]+$/.exec(document.location.hash);
    if(matchs != undefined && matchs.length == 1) {
      var tags = matchs[0].split(";");
      var serial = tags[0].substr(1);
      var name = tags.slice(1).join(";");

      beginControl(serial, name);
    } else {
      window.location = "discover.html";
    }
  });
  </script>
</head>
<body>
  <div class="container-fluid banner">
    <ol class="breadcrumb">
      <li><a href="index.html">Ghost</a></li>
      <li><a href="discover.html">Control</a></li>
      <li>
        <span id="device_label"></span>
        <a class="btn btn-xs btn-warning" data-role="reset-control">
          <i class="glyphicon glyphicon-repeat"></i>
        </a>
      </li>
    </ol>
  </div>
  <div class="container-fluid">
    <div class="col-xs-12">
      <div class="form-control" style="height: 400px; overflow-y: scroll; border: 1px gray solid" id="log"></div>
    </div>
  </div>
  <div class="container-fluid">
    <div class="col-xs-12">
      <div style="margin: 0.5em 0; display: none" data-cmd-group="raw">
        <span>Mainboard</span>
        <span data-cmd="G28" class="btn btn-xs btn-primary">G28</span>
        <div class="btn-group btn-xs dropup">
          <span data-cmd="G92 E0,G1F250E50" class="btn btn-xs btn-default">ÈÄÅÊñô</span>
          <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <span class="caret"></span>
              <span class="sr-only">Toggle Dropdown</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-right">
            <li class="dropdown-header">50 Á≥ªÂàó</li>
            <li data-cmd="G92E0,G1F6000E-500" style="cursor: pointer"><a>ÂÖâËº™ 50 (ÈÄÄÊñô)</a></li>
            <li data-cmd="G92E0,G1F6000E500" style="cursor: pointer"><a>ÂÖâËº™ 50 (ÈÄÅÊñô)</a></li>
            <li role="separator" class="divider"></li>
            <li class="dropdown-header">Âø´Âø´der</li>
            <li data-cmd="G92E0,G1F300E162" style="cursor: pointer"><a>ÂÖ¨ÈÅìÂÉπ x2</a></li>
            <li data-cmd="G92E0,G1F300E81" style="cursor: pointer"><a>ÂÖ¨ÈÅìÂÉπ 8.1cm</a></li>
            <li data-cmd="G92E0,G1F300E40.5" style="cursor: pointer"><a>ÂÖ¨ÈÅìÂÉπ x0.5</a></li>
            <li role="separator" class="divider"></li>
            <li class="dropdown-header">ÊôÆÈÄöÂø´</li>
            <li data-cmd="G92E0,G1F200E120" style="cursor: pointer"><a>Ëµ∞ 40 Áßí</a></li>
            <li data-cmd="G92E0,G1F200E60" style="cursor: pointer"><a>Ëµ∞ 20 Áßí</a></li>
            <li data-cmd="G92E0,G1F200E30" style="cursor: pointer"><a>Ëµ∞ 10 Áßí</a></li>
            <li role="separator" class="divider"></li>
            <li class="dropdown-header">ÊÖ¢ÊÖ¢ÈÄÅ</li>
            <li data-cmd="G92E0,G1F120E40" style="cursor: pointer"><a>Êì†Â∞ëÂ∞ë x4</a></li>
            <li data-cmd="G92E0,G1F120E20" style="cursor: pointer"><a>Êì†Â∞ëÂ∞ë x2</a></li>
            <li data-cmd="G92E0,G1F120E10" style="cursor: pointer"><a>Êì†Â∞ëÂ∞ë</a></li>
          </ul>
        </div>

        <span> | Head </span>
        <span data-cmd="1 DEBUG" class="btn btn-xs btn-default">Enable Head</span>
        <span data-cmd="1 PING *33" class="btn btn-xs btn-default">Ping Head</span>
        <div class="btn-group btn-xs dropup">
          <span data-cmd="-1 H:0 T:200 *15" class="btn btn-xs btn-default">Temp 200</span>
          <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <span class="caret"></span>
              <span class="sr-only">Toggle Dropdown</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-right">
            <li data-cmd="-1 H:0 T:210 *14" style="cursor: pointer"><a>Temp 210</a></li>
            <li data-cmd="-1 H:0 T:190 *5" style="cursor: pointer"><a>Temp 190</a></li>
          </ul>
        </div>
        <span data-cmd="quit" class="btn btn-xs btn-warning">Quit</span>
      </div>

      <div style="margin: 0.5em 0; display: none" data-cmd-group="maintain">
        <!-- filament -->
        <span data-cmd="maintain load_filament 0 210" class="btn btn-xs btn-default">Load filament</span>
        <span data-cmd="maintain unload_filament 0 210" class="btn btn-xs btn-default">Unload filament</span>

        <!-- calibrating -->
        <div class="btn-group btn-xs dropup">
          <span data-cmd="maintain calibrating" class="btn btn-xs btn-default">Calibrating</span>
          <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <span class="caret"></span>
              <span class="sr-only">Toggle Dropdown</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-right">
            <li data-cmd="maintain calibrating clean" style="cursor: pointer"><a>From clean</a></li>
          </ul>
        </div>

        <span data-cmd="maintain zprobe" class="btn btn-xs btn-default">
          Z-probe
        </span>

        <span data-cmd="maintain home" class="btn btn-xs btn-default">
          Home
        </span>

        <span data-cmd="maintain headinfo" class="btn btn-xs btn-default">
          Head Info
        </span>

        <span class="btn btn-xs btn-default fileinput-button">
          <span>** Update Head FW **</span>
          <input type="file" class="fileinput-button" data-file-cmd="maintain update_hbfw" name="file" />
        </span>
        <span data-cmd="task quit" class="btn btn-xs btn-warning">Quit</span>
      </div>
      <div style="margin: 0.5em 0" data-cmd-group="root">
        <!-- Report -->
        <div class="btn-group btn-xs dropup">
          <span data-cmd="report" class="btn btn-xs btn-default">Report</span>
          <span class="btn btn-xs btn-default">
            <span class="glyphicon glyphicon-new-window"></span>
          </span>
        </div> 

        <!-- List file -->
        <span data-cmd="file ls" class="btn btn-xs btn-default">
          <span class="glyphicon glyphicon-folder-open"></span> List files
        </span>

        <!-- Play -->
        <span> | Play</span>
        <div class="btn-group btn-xs">
          <span data-cmd="play start" class="btn btn-xs btn-primary"><i class="glyphicon glyphicon-fire"></i> Start</span>
          <span data-cmd="play info" class="btn btn-xs btn-default" data-toggle="tooltip" data-placement="top" title="Playing Info">
            <i class="glyphicon glyphicon-info-sign"></i> Play info</span>
          <span data-cmd="play pause" class="btn btn-xs btn-warning" data-toggle="tooltip" data-placement="top" title="Pause">
            <i class="glyphicon glyphicon-pause"></i> Pause</span>
          <span data-cmd="play resume" class="btn btn-xs btn-info" data-toggle="tooltip" data-placement="top" title="Resume">
            <i class="glyphicon glyphicon-play"></i> Resume</span>
          <span data-cmd="play abort" class="btn btn-xs btn-danger" data-toggle="tooltip" data-placement="top" title="Abort">
            <i class="glyphicon glyphicon-eject"></i> Abort</span>
        </div>

        <!-- Tasks -->
        <span> | Tasks</span>
        <div class="btn-group btn-xs dropup">
          <span data-cmd="task maintain" class="btn btn-xs btn-default">Maintain</span>
          <span data-cmd="task scan" class="btn btn-xs btn-default">Scan</span>
          <span data-cmd="task raw" class="btn btn-xs btn-info">Raw</span>
        </div>

        <div class="btn-group btn-xs dropup">
          <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <span>Config</span>
              <span class="caret"></span>
              <span class="sr-only">Toggle Dropdown</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-right">
            <li class="dropdown-header">correction: A a H N</li>
            <li data-cmd="config get correction" style="cursor: pointer"><a>GET</a></li>
            <li data-cmd-guide="config set correction " style="cursor: pointer"><a>SET</a></li>
            <li data-cmd="config del correction" style="cursor: pointer"><a>DEL</a></li>
            <li role="separator" class="divider"></li>
            <li class="dropdown-header">filament_detect: Y N</li>
            <li data-cmd="config get filament_detect" style="cursor: pointer"><a>GET</a></li>
            <li data-cmd-guide="config set filament_detect " style="cursor: pointer"><a>SET</a></li>
            <li data-cmd="config del filament_detect" style="cursor: pointer"><a>DEL</a></li>
            <li role="separator" class="divider"></li>
            <li class="dropdown-header">head_error_level: A number</li>
            <li data-cmd="config get head_error_level" style="cursor: pointer"><a>GET</a></li>
            <li data-cmd-guide="config set head_error_level " style="cursor: pointer"><a>SET</a></li>
            <li data-cmd="config del head_error_level" style="cursor: pointer"><a>DEL</a></li>
          </ul>
        </div>

        <!-- Update Device -->
        <div class="btn-group btn-xs dropup">
          <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <span>Update Device</span>
              <span class="caret"></span>
              <span class="sr-only">Toggle Dropdown</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-right">
            <li style="cursor: pointer; background-color: #E87A90"><a class="fileinput-button">
              <i class="glyphicon glyphicon-upload"></i>
              <span>** Update Mainboard Fireware **</span>
              <input type="file" class="fileinput-button" data-file-cmd="update_mbfw" name="file" />
            </a></li>
            <li style="cursor: pointer"><a class="fileinput-button">
              <i class="glyphicon glyphicon-upload"></i>
              <span>Update Device Fireware</span>
              <input type="file" class="fileinput-button" data-file-cmd="update_fw" name="file" />
            </a></li>
          </ul>
        </div>

        <span data-cmd="kick" style="margin-left: 10px;" class="btn btn-xs btn-danger">Kick</span>
      </div>
    </div>
  </div>
  <div class="container-fluid">
    <div class="col-xs-12">
      <div class="input-group input-group">
        <span class="input-group-addon">
          <i class="glyphicon glyphicon-console"></i>
          <span data-tag="current_task"></span>
        </span>
        <input id="controlcmd" type="text" class="form-control" autocomplete="off" />
        <div data-cmd-group="root" class="input-group-btn dropup">
          <span class="btn btn-primary fileinput-button">
              <i class="glyphicon glyphicon-upload"></i>
              <span>Upload</span>
              <input type="file" class="fileinput-button" data-file-cmd="upload" name="file" />
          </span>
          <span type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <span class="caret"></span>
            <span class="sr-only">Toggle Dropdown</span>
          </span>
          <ul class="dropdown-menu dropdown-menu-right">
            <li class="fileinput-button"><a>
              <i class="glyphicon glyphicon-upload"></i>
              <span>Upload To SD</span>
              <input type="file" class="fileinput-button" data-file-cmd="upload2sd" name="file" />
            </a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
