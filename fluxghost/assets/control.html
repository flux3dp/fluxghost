
<!DOCTYPE html>
<html>
<head>
  <title>FLUXStudio - Control</title>
  <script src="res/jquery-2.1.4.min.js"></script>
  <script src="res/bootstrap/js/bootstrap.min.js"></script>
  <script src="res/jsencrypt.js"></script>
  <link href="res/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
  <meta charset="UTF-8">
  <script src="shared.js"></script>
  <script src="control.js"></script>
  <link href="res/shared.css" rel="stylesheet" />
  <style>

  .status_nav {
    border-radius: 3px;
    background-color: #eee;
    margin-bottom: 0.5em;
    padding: 1px 6px;

    /* just avoid height change */
    height: 21px;
  }

  [data-tag=current_task]:first-letter {
    text-transform:uppercase;
  }

  #status_bar .st {
    display: inline-block;
  }

  #status_bar .st.split::before {
    content: " | ";
    color: #aaa;
  }

  #status_bar .st.st-id {
    font-size: 0.8em;
    min-width: 35px;
    margin-bottom: 2px;
  }

  #status_bar .st.st-label {
    min-width: 80px;
  }

  #status_bar .st.st-module::before {
    content: "TH ";
    font-size: 0.8em;
    font-weight: bold;
    color: #666;
  }

  #status_bar .st.st-prog::after {
    content: "%";
    font-size: 0.8em;
  }

  #status_bar .st.st-error {
    color: #f55;
    font-weight: 500;
  }

  #status_bar .st.st-position .X::before,
  #status_bar .st.st-position .Y::before,
  #status_bar .st.st-position .Z::before {
    font-size: 0.8em;
    font-weight: bold;
    color: #666;
  }

  #status_bar .st.st-position .X::before {
    content: "X ";
  }

  #status_bar .st.st-position .Y::before {
    content: " Y ";
  }

  #status_bar .st.st-position .Z::before {
    content: " Z ";
  }

  #status_bar .st.EXTRUDER .T::before {
    content: "TEMP";
    padding-right: 2px;
    font-size: 0.8em;
  }

  #status_bar .st.EXTRUDER .F::before {
    content: "FAN";
    padding-right: 2px;
    font-size: 0.8em;
  }

  #status_bar .st.OPERATION .BY::before {
    content: "BY ";
    font-size: 0.8em;
  }

  .file-node {
    overflow: hidden;
    margin-top: 2px;
    margin-bottom: 2px;
  }

  .file-file {
    min-height: 2em;
  }

  .file-node:hover {
    z-index: 100;
    overflow: initial;
  }


  .file-node a {
    cursor: pointer;
  }

  .file-node .file-node-container {
    white-space: nowrap;
    padding: 0.2em 0.4em;
    border: 1px white solid;
  }

  .file-node:hover .file-node-container {
    background-color: #FEDFE1;
    border: 1px #aaa solid;
    background: #eee;
    border-radius: 3px;
  }

  .file-node a[data-tag="info"],
  .file-node a[data-tag="download"] {
    display: none;
  }

  .file-node:hover a[data-tag="info"],
  .file-node:hover a[data-tag="download"] {
    display: initial;
  }

  .file-node:hover a[data-tag="select"] {
    display: inline-block;
  }

  .fileinput-button {
    position: relative;
    overflow: hidden;
  }
  .fileinput-button input {
    position: absolute;
    top: 0;
    right: 0;
    margin: 0;
    opacity: 0;
    -ms-filter: 'alpha(opacity=0)';
    font-size: 200px;
    direction: ltr;
    cursor: pointer;
  }

  .config-btn {
    display: inline-block;
    cursor: pointer;
    width: 32%;
    text-align: center;
  }

  .config-btn:hover {
    background-color: #ccc;
  }

  /* Fixes for IE < 8 */
  @media screen\9 {
    .fileinput-button input {
      filter: alpha(opacity=0);
      font-size: 100%;
      height: 100%;
    }
  }
  </style>
  <script>
  var filesinfo = {};
  var bcst_status = undefined;
  var auto_report = false;
  var aggressive_report = false;

  function ProgressBar(title) {
    var $html = $(' \
    <div> \
      <div style="padding: 0 2em; float: right"> \
        <span class="text_prog"></span> \
      </div> \
      <div style="padding: 0 2em;"> \
        <span class="text_title"></span> \
      </div> \
      <div class="progress" style="height: 0.5em; margin-bottom: 0.05em;"> \
        <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"> \
        </div> \
    </div>');

    this.html = $html;

    var size = 0;
    $(".text_title", $html).text(title);

    this.get_size = function() {
      return size;
    }

    this.update = function(complete_size, total_size) {
      size = total_size;
      var p = complete_size / total_size;
      p = Math.round(p * 1000) / 10;
      $(".progress-bar", $html).css("width", p + "%");
      $(".text_prog", $html).text(
        (total_size - complete_size) + " byte(s) left");
      if(complete_size === total_size) {
        $(".progress-bar", $html).addClass("progress-bar-success");
      }
    }
  }

  function render_fileinfo(filename) {
    function render_metadata(key, value) {
      var $tag = $('<span class="label label-default"></span>').text(key);
      var $val = $('<span class="label label-primary"></span>');
      if(value.length > 30) {
        $val.text(value.substr(0, 30) + " ...");
        $val.bind("click", function() {
          alert(value);
        });
      } else {
        $val.text(value);
      }
      return $('<div class="col-sm-6"></div>').append($tag).append($('<span> <span>')).append($val);
    }

    if(filesinfo[filename]) {
      var $m = $("#shared_modal");
      var $body = $(".modal-body", $m);
      $body.children().remove();
      $(".modal-title", $m).text(filename + " Preview");
      var p = filesinfo[filename].previews;
      var a = filesinfo[filename].attributes;
      if(p) {
        for(var i=0;i<p.length;i++) {
          $body
            .append($('<div></div>')
              .append($('<img class="img-thumbnail" />')
                .attr("src", URL.createObjectURL(p[i]))));
        }
      }
      var $attrs = $('<div class="row"></div>');
      for(var i=0;i<a.length;i++) {
        $attrs.append(render_metadata(
          a[i][0], a[i][1]))
      }
      $body.append($attrs);
      $m.modal('show');
    } else {
      return false;
    }
  }

  function render_buttons(st_id) {
    $("[data-sg]").hide();
    if(st_id < 0) {
      $("[data-sgn]").show();
    } else if(st_id == 0) {
      $("[data-sg0]").show();
    } else {
      $("[data-sgp]").show();
      $("[data-sg" + st_id + "]").show();
    }
  }

  function update_devicestatus(controller, cmd, payload) {
    var st_id = payload.device_status.st_id,
        st_label = payload.device_status.st_label;

    if(document.getElementById("agrp").checked) {
      window.aggressive_report = true;
    } else {
      window.aggressive_report = ([1, 4, 6, 18, 38, 50, 66].indexOf(st_id) >= 0);
    }
    render_buttons(st_id);
    var $panel = $("#status_bar");

    key = ["status"];
    data = {status: st_label + " (" + st_id + ")"}
    $(".st.st-id", $panel).text(st_id);
    $(".st.st-label", $panel).text(st_label);

    if(st_id < 0) {
      key.push("by"); data.by = payload.device_status.info;
      delete payload.device_status.info;
      $(".BY", $panel).text(data.by);
      $(".TH.OPERATION", $panel).show();
      $(".TH:not(.OPERATION)", $panel).hide();
      $(".st-playing", $panel).hide();
    }
    else if(st_id > 0) {
      key.push("module"); data.module = payload.device_status.module;
      key.push("prog"); data.prog = payload.device_status.prog;
      delete payload.device_status.module;
      delete payload.device_status.prog;

      if(data.module == "EXTRUDER") {
        var status_bar_temp_text = []

        for(var i=0;i<payload.device_status.rt.length;i++) {
          key.push("temp" + i);
          data["temp" + i] = payload.device_status.rt[i] + "/" + payload.device_status.tt[i];
          status_bar_temp_text.push(
            Math.round(payload.device_status.rt[i] * 10) / 10 + "/" + 
            Math.round(payload.device_status.tt[i] * 10) / 10);
        }

        $(".st.TH.EXTRUDER .T", $panel).text(status_bar_temp_text.join(", "));
        $(".st.TH.EXTRUDER .F", $panel).text(payload.device_status.FA);
        delete payload.device_status.tt;
        delete payload.device_status.rt;
      }

      if(payload.device_status.pos) {
        var X = payload.device_status.pos.X,
            Y = payload.device_status.pos.Y,
            Z = payload.device_status.pos.Z
        key.push("pos"); data.pos = "X:" + X + ", Y:" + Y + ", Z:" + Z;
      } else {
        key.push("pos"); data.pos = "X:?, Y:?, Z:?";
      }

      $(".st.st-module", $panel).text(data.module || "N/A");
      $(".st.st-prog", $panel).text(Math.round(data.prog * 10000) / 100);
      if(payload.device_status.error) {
        $(".st.st-error", $panel).text(payload.device_status.error.join(", "));
      }
      $(".st.st-position .X", $panel).text(Math.round(X * 100) / 100);
      $(".st.st-position .Y", $panel).text(Math.round(Y * 100) / 100);
      $(".st.st-position .Z", $panel).text(Math.round(Z * 100) / 100);
      delete payload.device_status.pos;

      $(".st-playing", $panel).show();
      if(data.module === "N/A") {
        $(".TH", $panel).hide();
      } else {
        $(".TH." + data.module, $panel).show();
        $(".TH:not(." + data.module + ")", $panel).hide();
      }
    } else {
      $(".TH", $panel).hide();
      $(".st-playing", $panel).hide();
    }

    for(var k in payload.device_status) {
      if(k === "st_id" || k === "st_label") { continue; }
      data[k] = payload.device_status[k];}

    return {"key": key, "data": data}
  }

  function update_fileinfo(filename, metadata, previews) {
    var DEFAULT_PROPERTIES = ["size", "TITLE", "AUTHOR", "CREATED_AT",
      "HEAD_TYPE", "CORRECTION", "FILAMENT_DETECT", "FILAMENT_USED",
      "HEAD_ERROR_LEVEL", "TIME_COST", "TRAVEL_DIST", "MAX_R", "MAX_X",
      "MAX_Y", "MAX_Z", "SETTING"];
    var attributes = [];
    for(var i=0;i<DEFAULT_PROPERTIES.length;i++) {
      var key = DEFAULT_PROPERTIES[i];
      if(metadata[key]) {
        attributes.push([key, metadata[key]]);
        delete metadata[key];
      }
    }
    for(var key in metadata) {
      attributes.push([key, metadata[key]]);
    }
    filesinfo[filename] = {attributes: attributes, previews: previews};
  }

  function global_on_operating(controller, cmd, payload, data) {
    var stage = payload.stage[0];
    var params = payload.stage.slice(1).join(' ');

    if(payload.stage[0] == "UPDATE_THFW" && payload.stage[1] == "WRITE") {
      if(!data.fw_prog) {
        data.fw_prog = new ProgressBar("Write firmware");
        appendHtmlLog(data.fw_prog.html);
      }
      data.fw_prog.update(payload.written, data.get_size());

      return;
    } else if(stage == "CALIBRATING") {
      params = payload.pos + " / 3";
    } else if(stage == "HEATING") {
      params = payload.temperature + " °C";
    }

    appendHtmlLog($('<div></div>')
      .append($('<span class="label label-primary"></span>')
        .append($("<i class=\"glyphicon glyphicon-transfer\"></i>"))
        .append($("<span></span>").html("&nbsp;"))
        .append($("<span></span>").text(stage)))
      .append($("<span></span>").html("&nbsp;"))
      .append($('<span></span>').text(params)));
  }

  function global_on_debug(controller, cmd, payload, data) {
    appendHtmlLog($('<div></div>')
      .append($('<span class="label label-default">DEVICE LOG</span>'))
      .append($('<span></span>').html("&nbsp;"))
      .append($('<span></span>').text(payload.log || payload.args)));
  }

  var callbacks = {
    error: function(controller, cmd, errors, data) {
      appendLog("Error: " + errors.join(", "), "#F05E1C");
    },
    handling: function(control, cmd, payload, data) {
      if(payload.status === "update_hbfw") {
        if(payload.stage === "WRITE") {
          if(window.last_update_write_hbfw) {
            var d = new Date();
            if((d - window.last_update_write_hbfw) < 1500) { return; }
          }

          window.last_update_write_hbfw = new Date();
          appendLog("Update head fw: Write " + payload.written);
        } else {
          appendLog("Update head fw: " + payload.stage);
        }
      }
    },
    deviceinfo: function(controller, cmd, payload) {
      delete payload.status;

      appendKeyValueLog(payload, ["serial", "uuid", "model", "version", "nickname"]);
      appendLog("ok");
    },
    "file ls": function(controller, cmd, payload) {
      appendLog("List " + payload.path + ":");

      var path = payload.path;
      if(path != "" && path[path.length - 1] != "/") {
        path = path + "/";
      }

      if(payload.directories != undefined) {
        var $row = $('<div class="row"></div>');
        for(var i=0;i<payload.directories.length;i++) {
          var dirname = payload.directories[i];
          var $item = $(' \
            <div class="col-xs-4 col-md-3 col-lg-2 file-node file-dir"> \
              <div class="file-node-container"> \
                <span class="glyphicon glyphicon-folder-close"></span> \
                  <a style="cursor: pointer;" > \
                    <span data-tag="name"></span> \
                  </a> \
                </span> \
              </div> \
            </div>');
          $("a", $item).attr("data-cmd", "file ls " + path + dirname);
          $("[data-tag=name]", $item).text("[" + path + dirname + "]");
          $row.append($item);
          appendHtmlLog($row);
        }
      }

      if(payload.files) {
        var $row = $('<div class="row"></div>');
        for(var i=0;i<payload.files.length;i++) {
          var filename = payload.files[i];
          var $item = $(' \
            <div class="col-xs-4 col-md-3 col-lg-2 file-node file-file"> \
              <div class="file-node-container"> \
                <span class="glyphicon glyphicon-picture"></span> \
                <a data-tag="select" style="cursor: pointer;"> \
                  <span data-tag="name"></span> \
                </a> \
                <a data-tag="info" class="btn btn-xs btn-default"> \
                  <span class="glyphicon glyphicon-info-sign"></span> \
                </a> &nbsp; \
                <a data-tag="download" class="btn btn-xs btn-default"> \
                  <span class="glyphicon glyphicon-download"></span> \
                </a> \
              </div> \
            </div>');
          $("a[data-tag=select]", $item).attr("data-cmd", "play select " + path + filename);
          $("a[data-tag=info]", $item)
            .attr("data-filename", path + filename)
            .bind("click", function() {
              var filename = $(this).attr("data-filename");
              if(filesinfo[filename]) {render_fileinfo(filename);}
              else{ send_cmd("file info " + filename); }
          });
          $("a[data-tag=download]", $item)
            .attr("data-filename", path + filename)
            .bind("click", function() {
              var filename = $(this).attr("data-filename");
              send_cmd("file download2 " + filename, callbacks["file download"]);
          });
          $("[data-tag=name]", $item).text("[" + filename + "]");
          $row.append($item);
          appendHtmlLog($row);
        }
      }
    },
    "file md5": function(controller, cmd, payload) {
      appendLog("MD5 " + payload.file + " " + payload.md5);
    },
    "file info": function(controller, cmd, payload) {
      delete payload.status;

      var filename = cmd.substr(10);
      var previews = payload.binaries;
      delete payload.binaries;

      update_fileinfo(filename, payload, previews)
      appendLog("File Info '" + cmd.substr(10) + "' recived.");
      render_fileinfo(filename);
    },
    "file download": function(controller, cmd, payload) {
      var splited_cmd = cmd.split("/");
      var filename = splited_cmd[splited_cmd.length - 1];

      var url = window.URL.createObjectURL(payload.binaries[0]);
      var a = document.createElement("a");
      document.body.appendChild(a);
      a.style = "display: none";

      a.href = url;
      a.download = filename;
      a.click();
      window.URL.revokeObjectURL(url);
    },
    "config get": function(controller, cmd, payload) {
      appendHtmlLog($("<div></div>")
        .append($('<span class="label label-primary"></span>').text(payload.key))
        .append($('<span>&nbsp;</span>'))
        .append($('<span></span>').text(payload.value)));
    },
    "config set": function(controller, cmd, payload) {
      var ll = cmd.split(" ");
      var value = ll.slice(3).join(" ");
      appendHtmlLog($("<div></div>")
        .append($('<span class="label label-warning"></span>').text(payload.key))
        .append($('<span>&nbsp;</span>'))
        .append($('<span></span>').text(value)));
    },
    "config del": function(controller, cmd, payload) {
      appendHtmlLog($("<div></div>")
        .append($('<span class="label label-danger"></span>').text(payload.key)));
    },
    "fetch_log": function(controller, cmd, payload) {
      var splited_cmd = cmd.split(" ");
      var filename = splited_cmd[splited_cmd.length - 1].replace(".log", ".txt");

      var url = window.URL.createObjectURL(payload.binaries[0]);
      var a = document.createElement("a");
      document.body.appendChild(a);
      a.style = "display: none";

      a.href = url;
      a.download = filename;
      a.click();
      window.URL.revokeObjectURL(url);
    },
    task: function(controller, cmd, payload) {
      $("[data-cmd-group]").hide()
      if(payload.task === "") {
        render_buttons(0);
        $("#status_bar").show();
        $("[data-tag=current_task]").text("");
        $("[data-cmd-group=root]").show();
      } else {
        $("#status_bar").hide();
        $("[data-tag=current_task]").text(payload.task);
        $("[data-cmd-group=" + payload.task + "]").show();
      }
      appendLog("ok");
    },
    "play start": function(controller, cmd, payload) { deviceStatusManager(8); appendLog("ok"); },
    "play pause": function(controller, cmd, payload) { deviceStatusManager(8); appendLog("ok"); },
    "play abort": function(controller, cmd, payload) { deviceStatusManager(8); appendLog("ok"); },
    "play select": function(controller, cmd, payload) {
      appendLog("File '" + payload.path + "' is selected");
      appendHtmlLog($('<div class="btn btn-primary btn-lg" data-cmd="play start"><i class="glyphicon glyphicon-fire"></i> Start</div>'));
    },
    ping: function(controller) {
    },
    "play info": function(controller, cmd, payload) {
      delete payload.status;

      var filename = cmd.substr(10);
      var previews = payload.binaries;
      delete payload.binaries;

      update_fileinfo(filename, payload, previews)
      appendLog("Playing information recived.");
      render_fileinfo(filename);
    },
    "play report": function(controller, cmd, payload) {
      var d = update_devicestatus(controller, cmd, payload);
      appendKeyValueLog(d.data, d.key);
    },
    "scan oneshot": function(controller, cmd, payload, data) {
      var width = (Math.round(100 / payload.binaries.length) - 1) + "%";
      var $r = $("<div></div>");

      for(var i=0;i<payload.binaries.length;i++) {
        var url = window.URL.createObjectURL(payload.binaries[i]);
        $r.append(
          $('<img class="img-thumbnail" />')
            .attr("src", url)
            .attr("width", width));
      }
      appendHtmlLog($r);
      appendLog("ok");
    },
    "scan scanimages": function(controller, cmd, payload, data) {
      callbacks["scan oneshot"](controller, cmd, payload, data);
    },
    "maintain headstatus": function(controller, cmd, payload, data) {
      delete payload.status;
      delete payload.cmd;
      appendKeyValueLog(payload, ["module"]);
    },
    "maintain headinfo": function(controller, cmd, payload, data) {
      delete payload.status;
      delete payload.cmd;
      appendKeyValueLog(payload, ["module"]);
    },
    "maintain diagnosis_sensor": function(controller, cmd, payload, data) {
      appendKeyValueLog(payload.sensor, ["FSR0", "FSR1", "FSR2", "RIO1", "RIO2", "MIO1", "F0_STOP", "F1_STOP"]);
    },
    default: function(controller, cmd, payload) {
      if(payload.constructor === String) {
        var lines = payload.split("\n");
        for(var i=0;i<lines.length;i++) {
          appendLog(lines[i]);
        }
      } else {
        var log = JSON.stringify(payload);
        if(log === '{"status":"ok"}') {
          appendLog("ok");
        } else {
          appendLog(JSON.stringify(payload));
        }
      }
    }
  }

  function beginControl(uuid, name) {
    $("#device_label").
      text(name + " (" + uuid + ")").
      attr("data-uuid", uuid).
      attr("data-name", name);

    connectControl();
  }

  function connectControl() {
    if(window.controller) {
      appendLog("Clean old control session", "red");

      window.controller.close();
      window.controller = undefined;
    }
    var uuid = $("#device_label").attr("data-uuid");

    if(window.device_information.usb) {
      appendLog("Connect to USB: " + window.device_information.usb_addr);
    } else {
      appendLog("Connect to " + uuid);
    }

    var control_opts = {
      clientkey: getKeyPem(),
      baseurl: getCorrectDomainName(window.location),
      usb: window.device_information.usb,
      usb_addr: window.device_information.usb_addr,
      on_connecting: function(sender, stage) {
        appendLog("Connecting... (" + stage + ")", "#444");
      },
      on_connected: function(sender) {
        deviceStatusManager(1);
        appendLog("➜ Ready")
        appendHtmlLog('<div>' +
          '<img src="ready.png?" height="60px" />' +
          '<img src="ready.png?" height="60px" />' +
          '<img src="ready.png?" height="60px" />' + '</div>');
      },
      on_error: callbacks.error,
      on_raw: function(sender, text) {
        var lines = text.split("\n");
        for(var i=0;i<lines.length;i++) {
          var line = lines[i];
          if(line.length > 0) appendLog(lines[i]);
        }
      },
      on_fatal: function(sender, source, cmd, errors) {
        if(errors[0] === "AUTH_ERROR") {
            var $label = $("#device_label");
            appendLog("✗ Error: Auth failed", "red");
            appendHtmlLog('<a href="touch.html#' + $label.attr("data-uuid") + 
                          ';' + $label.attr("data-name") + '">Go to auth page</a>');
          } else {
            appendLog("✗ Error: "+ errors + " 😭", "red");
          }
      },
      on_close: function(sender, wsparam) {
        if(window.controller === sender) {
          window.controller = undefined;
        }
        ws_close_handler("Control")(wsparam)
      }
    };
    window.controller = new FLUXControl(uuid, control_opts);
  }

  function dispatch_handler(cmd) {
    for(var key in callbacks) {
        if(cmd.startsWith(key + " ") || cmd == key) {
          return callbacks[key];
        }
    }
    return callbacks.default;
  }

  function send_cmd(cmd, handler, data) {
    var cb = handler ? handler : dispatch_handler(cmd);
    if(window.controller) {
      try {
        window.controller.send_command(cmd, {
          on_success: cb,
          on_transfer_begin: function(controller, datasize, data) {
            data.transfer_prog = new ProgressBar("Data transfer");
            appendHtmlLog(data.transfer_prog.html);
            data.transfer_prog.update(0, datasize);
          },
          on_transfer: function(controller, recivedsize, datasize, data) {
            if(data.transfer_prog) {
              data.transfer_prog.update(recivedsize, datasize);
            }
          },
          on_operating: global_on_operating,
          on_debug: global_on_debug,
          data: (data || {})
        });

        appendLog("➦ " + cmd, undefined, "#eeeeee");
      } catch(err) {
        appendLog("⚠️ Error: " + err, "rgb(208, 142, 40)");
      }
    } else {
      appendLog("⚠️ Not Connected, can not send '" + cmd + "'",
                "rgb(208, 142, 40)");
    }
  }

  function _deviceStatusManager(reset_on_error) {
    if(auto_report === false && $("[data-tag=current_task]").text() === "") {
      if(window.controller && window.controller.status() === "CONNECTED" && window.controller.is_busy() === false) {
        auto_report = true;

        window.controller.send_command("play report", {
          on_success: function(controller, command, payload) {
            auto_report = false;
            update_devicestatus(controller, command, payload);
          },
          on_error: function(sender, cmd, errors, data) {
            if(reset_on_error) {
              setTimeout(deviceStatusManager, 700);
            }
          }
        });
      }
    }
  }

  function deviceStatusManager(aggressive) {
    if(aggressive === 1) {
      setTimeout(_deviceStatusManager, 10);
    } else if(aggressive === 8) {
      setTimeout(_deviceStatusManager, 300);
    } else {
      _deviceStatusManager(true);
      setTimeout(deviceStatusManager, window.aggressive_report ? 700 : 3000);
    }
  }

  $(window).ready(function() {
    $("[data-role=reset-control]").on("click", function() {
      connectControl();
    });

    $("#controlcmd").on("keypress", function(e) {
      if(e.keyCode == 13) {
        var val = $(this).val();
        send_cmd(val);
        $(this).val("");
        return false;
      }
    });

    $("#log").on("click", "[data-cmd]", function() {
      cl = $(this).attr("data-cmd").split(",")
      for(var i=0;i<cl.length;i++) {
        send_cmd(cl[i]);
      }
    });

    $("[data-cmd-guide]").bind("click", function() {
      $("#controlcmd")
        .val($(this).attr("data-cmd-guide"))
        .focus();
    });

    $("[data-cmd]").bind("click", function() {
      if($(this).attr("data-cmd-require-param")) {
        var val = prompt($(this).attr("data-cmd-param-help").replace(/\\n/g, "\n"));
        if(!val) {
          appendLog("Command canceled: '" + $(this).attr("data-cmd") + "'");
          return;
        }
        var cmd = $(this).attr("data-cmd").replace(/{}/g, val);
        send_cmd(cmd);
      } else {
        cmds = $(this).attr("data-cmd").split(",");
        for(var i=0;i<cmds.length;i++) {
          send_cmd(cmds[i]);
        }
      }
    });

    // Upload File Codes
    $("input[name=file]").on("change", function(evt) {
      var f = evt.target.files[0];

      // Get mimetype
      var mimetype = undefined;
      var filename = f.name.split(".");
      var fileext = filename[filename.length - 1].toLowerCase();
      if(fileext == "gcode") {
        mimetype = "text/gcode";
      } else if (fileext == "fc") {
        mimetype = "application/fcode";
      } else if (fileext == "bin"){
        mimetype = "binary/firmware";
      } else if (fileext == "fxfw") {
        mimetype = "binary/flux-firmware";
      } else {
        alert("Unknow file type");
        return
      }

      if($(this).attr("data-file-cmd") == "upload2sd"){
        var target = prompt("Give SD location (like 'myfcode.fc'");
        var cmd = "upload " + " " + mimetype + " " + 
                    f.size + " SD/" + target;
      }
      else{
        var cmd = $(this).attr("data-file-cmd") + " " + mimetype + " " + f.size;
      }

      appendLog("Start uploading... (" + cmd + ")");

      window.controller.send_command(cmd, {
        data: new ProgressBar("Upload file..."),
        on_error: function(sender, cmd, errors, data) {
          appendLog("Error: " + errors.join(", "), "#F05E1C");
        },
        on_upload_begin: function(sender, size, prog) {
          appendHtmlLog(prog.html);
          prog.update(0, size);
        },
        on_uploading: function(sender, sent, amount, prog) {
          prog.update(sent, amount);
        },
        on_success: function(sender, cmd, result, prog) {
          appendLog("ok");
        },
        on_operating: global_on_operating,
        on_debug: global_on_debug,
        file: f,
      });
    });
    // End Upload File Codes

    deviceStatusManager();

    // Begin UI
    var match_uuid = /^#[0-9a-fA-F]+;[\w\W]+$/.exec(document.location.hash);
    var match_usb = /^#USB:[0-9]+;[\w\W]+$/.exec(document.location.hash);
    if(match_uuid != undefined && match_uuid.length == 1) {
      var tags = match_uuid[0].split(";");
      var uuid = tags[0].substr(1);
      var name = tags.slice(1).join(";");

      window.device_information = {uuid: uuid, name: name};
      beginControl(uuid, name);
    } else if(match_usb != undefined && match_usb.length == 1) {
      var tags = match_usb[0].split(";");
      var usbaddr = tags[0].substr(5);
      var uuid = tags[1];
      var name = tags.slice(2).join(";");

      window.device_information = {uuid: uuid, name: name, usb: true,
                                   usb_addr: usbaddr};
      beginControl(uuid, name);
    } else {
      window.location = "discover.html";
    }

    $("[data-sg]").hide();
  });
  </script>
</head>
<body>
  <div class="container-fluid banner">
    <ol class="breadcrumb">
      <li><a href="index.html">Ghost</a></li>
      <li><a href="discover.html">Devices</a></li>
      <li>Control</li>
      <li>
        <span id="device_label"></span>
        <a class="btn btn-xs btn-warning" data-role="reset-control">
          <i class="glyphicon glyphicon-repeat"></i>
        </a>
      </li>
    </ol>
  </div>
  <div class="container-fluid" style="margin-top: -1em;">
    <div class="col-xs-12">
      <div class="status_nav">
        <div data-tag="current_task"></div>
        <div id="status_bar">
          <div class="st updated pull-right">
            <label style="background-color: #0af; border-radius: 2px; padding: 0 0.5em;">
              <input type="checkbox" id="agrp" style="vertical-align:top;" />
              <span class="glyphicon glyphicon-flash"></span>
            </label>
            <a data-cmd="play report" style="cursor: pointer;">More...</a>
          </div>

          <span class="badge st st-id">??</span>
          <div class="st st-label st-playing">----</div>
          <div class="st st-prog st-playing split">??</div>
          <div class="st st-module st-playing">----</div>
          <div class="st st-error st-playing">^_^</div>
          <div class="st st-position st-playing split">
            <span class="X">??</span><span class="Y">??</span><span class="Z">??</span>
          </div>

          <div class="st split TH EXTRUDER">
            <span class="T">??/??, ??/??</span>
            <span class="F">??</span>
          </div>

          <div class="st split TH OPERATION">
            <span class="BY"></span>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="container-fluid">
    <div class="col-xs-12">
      <div class="form-control" style="height: 400px; overflow-y: scroll; border: 1px gray solid" id="log">
      </div>
    </div>
  </div>
  <div class="container-fluid">
    <div class="col-xs-12">
      <div style="margin: 0.5em 0; display: none" data-cmd-group="raw">
        <span>Mainboard</span>
        <span data-cmd="G28" class="btn btn-xs btn-primary">G28</span>
        <div class="btn-group btn-xs dropup">
          <span data-cmd="G92 E0,G1F250E50" class="btn btn-xs btn-default">送料</span>
          <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <span class="caret"></span>
              <span class="sr-only">Toggle Dropdown</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-right">
            <li class="dropdown-header">50 系列</li>
            <li data-cmd="G92E0,G1F6000E-500" style="cursor: pointer"><a>光輪 50 (退料)</a></li>
            <li data-cmd="G92E0,G1F6000E500" style="cursor: pointer"><a>光輪 50 (送料)</a></li>
            <li role="separator" class="divider"></li>
            <li class="dropdown-header">快快der</li>
            <li data-cmd="G92E0,G1F300E162" style="cursor: pointer"><a>公道價 x2</a></li>
            <li data-cmd="G92E0,G1F300E81" style="cursor: pointer"><a>公道價 8.1cm</a></li>
            <li data-cmd="G92E0,G1F300E40.5" style="cursor: pointer"><a>公道價 x0.5</a></li>
            <li role="separator" class="divider"></li>
            <li class="dropdown-header">普通快</li>
            <li data-cmd="G92E0,G1F200E120" style="cursor: pointer"><a>走 40 秒</a></li>
            <li data-cmd="G92E0,G1F200E60" style="cursor: pointer"><a>走 20 秒</a></li>
            <li data-cmd="G92E0,G1F200E30" style="cursor: pointer"><a>走 10 秒</a></li>
            <li role="separator" class="divider"></li>
            <li class="dropdown-header">慢慢送</li>
            <li data-cmd="G92E0,G1F120E40" style="cursor: pointer"><a>擠少少 x4</a></li>
            <li data-cmd="G92E0,G1F120E20" style="cursor: pointer"><a>擠少少 x2</a></li>
            <li data-cmd="G92E0,G1F120E10" style="cursor: pointer"><a>擠少少</a></li>
          </ul>
        </div>

        <span> | Head </span>
        <span data-cmd="1 DEBUG" class="btn btn-xs btn-default">Enable Head</span>
        <span data-cmd="1 PING *33" class="btn btn-xs btn-default">Ping Head</span>
        <div class="btn-group btn-xs dropup">
          <span data-cmd="-1 H:0 T:200 *15" class="btn btn-xs btn-default">Temp 200</span>
          <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <span class="caret"></span>
              <span class="sr-only">Toggle Dropdown</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-right">
            <li data-cmd="-1 H:0 T:210 *14" style="cursor: pointer"><a>Temp 210</a></li>
            <li data-cmd="-1 H:0 T:190 *5" style="cursor: pointer"><a>Temp 190</a></li>
          </ul>
        </div>
        <span data-cmd="task quit" class="btn btn-xs btn-warning">Quit</span>
      </div>

      <div style="margin: 0.5em 0; display: none" data-cmd-group="scan">
        <span data-cmd="scan oneshot" class="btn btn-xs btn-default">One shot</span>
        <span data-cmd="scan scanimages" class="btn btn-xs btn-default">Imagesets</span>

        <span class="btn-group">
          <span data-cmd="scan backward" class="btn btn-xs btn-default">
            <i class="glyphicon glyphicon-chevron-left"></i>
          </span>
          <span data-cmd="scan forward" class="btn btn-xs btn-default">
            <i class="glyphicon glyphicon-chevron-right"></i>
          </span>
        </span>

        <span data-cmd="scan step {}" data-cmd-require-param="1" data-cmd-param-help="Give step length" class="btn btn-xs btn-default">
          Set step
        </span>

        <span data-cmd="task quit" class="btn btn-xs btn-warning">Quit</span>
      </div>

      <div style="margin: 0.5em 0; display: none" data-cmd-group="maintain">
        <span data-cmd="maintain home" class="btn btn-xs btn-default">
          Home
        </span>

        <div class="btn-group">
          <span data-cmd="maintain load_filament 0 210" class="btn btn-xs btn-default">Load filament</span>
          <span data-cmd="maintain unload_filament 0 210" class="btn btn-xs btn-default">Unload filament</span>
        </div>

        <!-- calibrating -->
        <div class="btn-group btn-xs dropup">
          <span data-cmd="maintain calibrating" class="btn btn-xs btn-default">Calibrating</span>
          <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <span class="caret"></span>
              <span class="sr-only">Toggle Dropdown</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-right">
            <li data-cmd="maintain calibrating clean" style="cursor: pointer"><a>From clean</a></li>
          </ul>
        </div>

        <span data-cmd="maintain zprobe" class="btn btn-xs btn-default">
          Z-probe
        </span>

        <span> | Head </span>
        <div class="btn-group">
          <span data-cmd="maintain headinfo" class="btn btn-xs btn-default">
            Profile
          </span>
          <span data-cmd="maintain headstatus" class="btn btn-xs btn-default">
            Status
          </span>
        </div>

        <span class="btn btn-xs btn-default" data-cmd="maintain set_heater 0 {}"
              data-cmd-require-param="1"data-cmd-param-help="Give temperature">
          Heater
        </span>

        <span class="btn btn-xs btn-default fileinput-button">
          <span>** Update Head FW **</span>
          <input type="file" class="fileinput-button" data-file-cmd="maintain update_hbfw" name="file" />
        </span>
        <span data-cmd="task quit" class="btn btn-xs btn-warning">Quit</span>
      </div>
      <div style="margin: 0.5em 0" data-cmd-group="root">
        <!-- List file -->
        <span data-cmd="file ls" class="btn btn-xs btn-default">
          <span class="glyphicon glyphicon-folder-open"></span> List files
        </span>

        <!-- Play -->
        <span> | Play</span>
        <span data-cmd="play start" data-sg data-sg0 class="btn btn-xs btn-primary"><i class="glyphicon glyphicon-fire"></i> Start</span>
        <span data-cmd="play info" data-sg data-sgp class="btn btn-xs btn-primary" data-toggle="tooltip" data-placement="top" title="Playing Info">
          <i class="glyphicon glyphicon-info-sign"></i> Playing info</span>
        <span data-cmd="play pause" data-sg data-sg4 data-sg16 class="btn btn-xs btn-warning" data-toggle="tooltip" data-placement="top" title="Pause">
          <i class="glyphicon glyphicon-pause"></i> Pause</span>
        <span data-cmd="play resume" data-sg data-sg36 data-sg48 class="btn btn-xs btn-info" data-toggle="tooltip" data-placement="top" title="Resume">
          <i class="glyphicon glyphicon-play"></i> Resume</span>
        <span data-cmd="play abort" data-sg data-sg4 data-sg18 data-sg36 data-sg48 data-sg50 data-sg16 class="btn btn-xs btn-danger" data-toggle="tooltip" data-placement="top" title="Abort">
          <i class="glyphicon glyphicon-remove"></i> Abort</span>
        <span data-cmd="play quit" data-sg data-sg64 data-sg128 class="btn btn-xs btn-default" data-toggle="tooltip" data-placement="top" title="Quit">
          <i class="glyphicon glyphicon-eject"></i> Quit</span>
        <span data-cmd="kick" data-sg data-sgn style="margin-left: 10px;" class="btn btn-xs btn-danger">Kick</span>

        <span data-sg data-sg48>
          <span>Toolhead</span>
          <span class="btn-group">
            <span class="btn btn-default btn-xs" data-cmd="play toolhead operation">Enable</span>
            <span class="btn btn-default btn-xs" data-cmd="play toolhead standby">Disable</span>
            <span class="btn btn-default btn-xs" data-cmd="play toolhead heater 0 {}"
                  data-cmd-require-param="1"
                  data-cmd-param-help="Give temp">Heater</span>
          </span>
          <span>Filament</span>
          <span class="btn-group">
            <span class="btn btn-default btn-xs" data-cmd="play load_filament 0">Load</span>
            <span class="btn btn-default btn-xs" data-cmd="play unload_filament 0">Unload</span>
            <span class="btn btn-default btn-xs" data-cmd="play press_button">Interrupt</span>
          </span>
        </span>

        <!-- Tasks -->
        <span data-sg data-sg0>
          <span> | Tasks </span>
          <div class="btn-group btn-xs">
            <span data-cmd="task maintain" class="btn btn-xs btn-default">Maintain</span>
            <span data-cmd="task scan" class="btn btn-xs btn-default">Scan</span>
            <span data-cmd="task raw" class="btn btn-xs btn-info">Raw</span>
          </div>
        </span>

        <span> | </span>

        <!-- Configs -->
        <span> Config </span>
        <div class="btn-group btn-xs">
          <div class="btn-group dropup">
            <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <span>General</span>
                <span class="caret"></span>
                <span class="sr-only">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-right">
              <li class="dropdown-header">correction: A a H N (default:Y)</li>
              <li>
                <div data-cmd="config get correction" class="config-btn">GET</div>
                <div data-cmd="config set correction {}" class="config-btn"
                     data-cmd-require-param="1"
                     data-cmd-param-help="Correction option:\nA: Do all\nH: Do Z-probe only\nN: No correction">SET</div>
                <div data-cmd="config del correction" class="config-btn">DEL</div>
              </li>

              <li role="separator" class="divider"></li>
              <li class="dropdown-header">filament_detect: Y N (default:Y)</li>
              <li>
                <div data-cmd="config get filament_detect" class="config-btn">GET</div>
                <div data-cmd="config set filament_detect {}" class="config-btn"
                     data-cmd-require-param="1"
                     data-cmd-param-help="Filament Detect option:\nY: Enable\nN: Disable">SET</div>
                <div data-cmd="config del filament_detect" class="config-btn">DEL</div>
              </li>

              <li role="separator" class="divider"></li>
              <li class="dropdown-header">head_error_level: A number</li>
              <li>
                <div data-cmd="config get head_error_level" class="config-btn">GET</div>
                <div data-cmd="config set head_error_level {}" class="config-btn"
                     data-cmd-param-help="Head error level:"
                     data-cmd-require-param="1">SET</div>
                <div data-cmd="config del head_error_level" class="config-btn">DEL</div>
              </li>

              <li role="separator" class="divider"></li>
              <li class="dropdown-header">autoresume: Y N (default:N)</li>
              <li>
                <div data-cmd="config get autoresume" class="config-btn">GET</div>
                <div data-cmd="config set autoresume {}" class="config-btn"
                     data-cmd-param-help="Correction option:\nY: Enable\nN: Disable"
                     data-cmd-require-param="1">SET</div>
                <div data-cmd="config del autoresume" class="config-btn">DEL</div>
              </li>

              <li role="separator" class="divider"></li>
              <li class="dropdown-header">broadcast: L A N (default:L)</li>
              <li>
                <div data-cmd="config get broadcast" class="config-btn">GET</div>
                <div data-cmd="config set broadcast {}" class="config-btn"
                     data-cmd-param-help="Broadcast option:\nL: Lazy\nA: Aggressive\nN: Disable"
                     data-cmd-require-param="1">SET</div>
                <div data-cmd="config del broadcast" class="config-btn">DEL</div>
              </li>
            </ul>
          </div>

          <div class="btn-group dropup">
            <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <span>Advance</span>
                <span class="caret"></span>
                <span class="sr-only">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-right">
              <li class="dropdown-header">enable_backlash: Y N (default:N)</li>
              <li>
                <div data-cmd="config get enable_backlash" class="config-btn">GET</div>
                <div data-cmd="config set enable_backlash {}" class="config-btn"
                     data-cmd-require-param="1"
                     data-cmd-param-help="Enable backlash option:\nY: Enable\nN: Disable">SET</div>
                <div data-cmd="config del enable_backlash" class="config-btn">DEL</div>
              </li>

              <li role="separator" class="divider"></li>
              <li class="dropdown-header">backlash: (number) (default:10)</li>
              <li>
                <div data-cmd="config get backlash" class="config-btn">GET</div>
                <div data-cmd='config set backlash "A:{} B:{} C:{}"' class="config-btn"
                     data-cmd-require-param="1"
                     data-cmd-param-help="backlash option: Give a NUMBER">SET</div>
                <div data-cmd="config del backlash" class="config-btn">DEL</div>
              </li>
            </ul>
          </div>
        </div>

        <span> | <span>

        <!-- Device info -->
        <span data-cmd="deviceinfo" style="margin-left: 10px;" class="btn btn-xs btn-default">
          <i class="glyphicon glyphicon-info-sign"></i>
          Device Info
        </span>

        <!-- Update Device -->
        <div class="btn-group btn-xs dropup" data-sg data-sg0>
          <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <span>Update Device</span>
              <span class="caret"></span>
              <span class="sr-only">Toggle Dropdown</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-right">
            <li style="cursor: pointer; background-color: #E87A90"><a class="fileinput-button">
              <i class="glyphicon glyphicon-upload"></i>
              <span>** Update Mainboard Firmware **</span>
              <input type="file" class="fileinput-button" data-file-cmd="update_mbfw" name="file" />
            </a></li>
            <li style="cursor: pointer"><a class="fileinput-button">
              <i class="glyphicon glyphicon-upload"></i>
              <span>Update Device Firmware</span>
              <input type="file" class="fileinput-button" data-file-cmd="update_fw" name="file" />
            </a></li>
          </ul>
        </div>

        <!-- Fetch log -->
        <div class="btn-group btn-xs dropup">
          <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <span>Log</span>
              <span class="caret"></span>
              <span class="sr-only">Toggle Dropdown</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-right">
            <li style="cursor: pointer" data-cmd="fetch_log fluxnetworkd.log">
              <a>Network</a></li>
            <li style="cursor: pointer" data-cmd="fetch_log fluxhald.log">
              <a>Hardware</a></li>
            <li style="cursor: pointer" data-cmd="fetch_log fluxupnpd.log">
              <a>Discover</a></li>
            <li style="cursor: pointer" data-cmd="fetch_log fluxusbd.log">
              <a>USB</a></li>
            <li style="cursor: pointer" data-cmd="fetch_log fluxcamerad.log">
              <a>Camera</a></li>
            <li style="cursor: pointer" data-cmd="fetch_log fluxcloudd.log">
              <a>Cloud</a></li>
            <li style="cursor: pointer" data-cmd="fetch_log fluxplayerd.log">
              <a>Player</a></li>
            <li style="cursor: pointer" data-cmd="fetch_log fluxrobotd.log">
              <a>Robot</a></li>
          </ul>
        </div>

      </div>
    </div>

    <div class="col-xs-12">
      <div class="input-group input-group">
        <span class="input-group-addon">
          <i class="glyphicon glyphicon-console"></i>
        </span>
        <input id="controlcmd" type="text" class="form-control" autocomplete="off" />
        <div data-cmd-group="root" class="input-group-btn dropup">
          <span class="btn btn-primary fileinput-button">
              <i class="glyphicon glyphicon-upload"></i>
              <span>Upload</span>
              <input type="file" class="fileinput-button" data-file-cmd="upload" name="file" />
          </span>
          <span type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <span class="caret"></span>
            <span class="sr-only">Toggle Dropdown</span>
          </span>
          <ul class="dropdown-menu dropdown-menu-right">
            <li class="fileinput-button"><a>
              <i class="glyphicon glyphicon-upload"></i>
              <span>Upload To SD</span>
              <input type="file" class="fileinput-button" data-file-cmd="upload2sd" name="file" />
            </a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div id="shared_modal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title">Modal title</h4>
        </div>
        <div class="modal-body">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

</body>
</html>
